version: '3.9'

services:
  step-function-local:
    image: amazon/aws-stepfunctions-local:1.12.0
    ports:
      - "8083:8083"
    volumes:
      - ${PWD}/transition_tests/StepFunctionsMock.json:/home/StepFunctionsLocal/MockConfigFile.json
    environment:
      - AWS_ACCOUNT_ID=000000000000
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=DUMMY
      - AWS_SECRET_ACCESS_KEY=DUMMY
      - LAMBDA_ENDPOINT=http://localstack:4566
      - BATCH_ENDPOINT=http://localstack:4566
      - DYNAMODB_ENDPOINT=http://localstack:4566
      - ECS_ENDPOINT=http://localstack:4566
      - GLUE_ENDPOINT=http://localstack:4566
      - SAGE_MAKER_ENDPOINT=http://localstack:4566
      - SQS_ENDPOINT=http://localstack:4566
      - SNS_ENDPOINT=http://localstack:4566
      - SFN_MOCK_CONFIG=/home/StepFunctionsLocal/MockConfigFile.json
    networks:
      - localstack-net
    depends_on:
      - localstack

  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME-localstack_main}"
    image: localstack/localstack:1.3.0
    ports:
      - "127.0.0.1:4566:4566"            # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559"  # external services port range
      - "127.0.0.1:53:53"                # DNS config (only required for Pro)
      - "127.0.0.1:53:53/udp"            # DNS config (only required for Pro)
      - "127.0.0.1:443:443"              # LocalStack HTTPS Gateway (only required for Pro)
    environment:
      - DEBUG=${DEBUG-}
      - PERSISTENCE=${PERSISTENCE-}
      - LAMBDA_EXECUTOR=local
      - LOCALSTACK_API_KEY=${LOCALSTACK_API_KEY-}  # only required for Pro
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - localstack-net

  tenant-service:
    image: ghcr.io/jitsecurity/tenant-service-mock:latest
    ports:
      - "8082:80"
    networks:
      - localstack-net

  github-service:
    image: ghcr.io/jitsecurity/github-service-mock:latest
    ports:
      - "8085:80"
    networks:
      - localstack-net

  asset-service:
    image: ghcr.io/jitsecurity/asset-service-mock:latest
    ports:
      - "8088:80"
    networks:
      - localstack-net

  plan-service:
    image: ghcr.io/jitsecurity/plan-service:latest
    ports:
      - "8089:80"
    networks:
      - localstack-net

  authentication-service:
    image: ghcr.io/jitsecurity/authentication-service-mock:latest
    ports:
      - "8091:80"
    networks:
      - localstack-net

networks:
  localstack-net:
    name: localstack-net
